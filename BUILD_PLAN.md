# 科学论文评审平台 - 构建计划

## 项目概述
网络存储一体化平台，集成虚拟文件系统、客户端-服务器通信和并发处理。

---

## 阶段规划（Phase-based Development）

### **Phase 1: 核心功能稳定化（Week 1-2）**
目标：确保当前原型的功能完整性和代码质量

#### Task 1.1: 单元测试框架搭建
- [ ] 建立gtest/catch2测试框架
- [ ] 编写VFS核心操作的测试用例
  - [ ] SuperBlock初始化测试
  - [ ] Inode分配/释放测试
  - [ ] Bitmap操作正确性测试
  - [ ] 文件上传/下载正确性验证
- **优先级**：🔴 高
- **预期周期**：3-4天
- **输出物**：test_suite, 覆盖率报告

#### Task 1.2: 协议规范文档化
- [ ] 编写API文档（RequestHeader/ResponseStructure）
- [ ] 定义所有CommandType的详细行为
- [ ] 错误码标准化（e.g., 200, 400, 507等）
- [ ] 生成Protocol版本号管理方案
- **优先级**：🟡 中
- **预期周期**：2-3天
- **输出物**：Protocol_Spec_v1.0.md

#### Task 1.3: 内存泄漏和并发bug修复
- [ ] 运行valgrind/Address Sanitizer检查
- [ ] 修复所有内存泄漏
- [ ] 添加关键段的竞态条件检测
- [ ] 文档化已知限制
- **优先级**：🔴 高
- **预期周期**：2-3天
- **输出物**：Clean build log

---

### **Phase 2: 高并发支持（Week 3-4）**
目标：从全局锁升级到细粒度同步，支持数百并发连接

#### Task 2.1: Inode级互斥锁设计与实现
- [ ] 为INode结构体添加pthread_mutex_t成员
- [ ] 重构文件操作接口（read/write/allocate）
  - [ ] 细粒度加锁逻辑
  - [ ] 死锁预防机制（按INode ID顺序加锁）
  - [ ] 锁超时处理
- [ ] 保留SuperBlock/Bitmap全局锁（可选：后续升级）
- **优先级**：🔴 高
- **预期周期**：5-6天
- **输出物**：Refactored filesystem.c, 并发测试报告

#### Task 2.2: 服务器并发框架升级
- [ ] 从单线程/简单多线程升级到线程池架构
  - [ ] 实现线程池 (建议4-16个工作线程)
  - [ ] 任务队列实现 (queue size = 256)
  - [ ] 工作线程生命周期管理
- [ ] 连接管理器 (支持max 512并发连接)
  - [ ] 使用epoll/select轮询socket
  - [ ] 心跳检测与超时断开 (30s timeout)
- [ ] 日志系统升级（线程安全的日志输出）
- **优先级**：🔴 高
- **预期周期**：5-6天
- **输出物**：server_v2.c, 并发压力测试脚本

#### Task 2.3: 并发测试验证
- [ ] 编写压力测试客户端 (模拟100+并发上传)
- [ ] 验证文件一致性 (并发写入同一文件不损坏)
- [ ] 性能基准测试
  - [ ] 单客户端吞吐量 (MB/s)
  - [ ] 并发10客户端的总吞吐量
  - [ ] 平均延迟测试
- [ ] 生成性能报告
- **优先级**：🟡 中
- **预期周期**：3-4天
- **输出物**：stress_test.py, performance_report.xlsx

---

### **Phase 3: 存储优化（Week 5-6）**
目标：实现缓存层和多级寻址，支持大文件存储

#### Task 3.1: LRU块缓存实现
- [ ] 设计缓存架构
  - [ ] 缓存大小：16MB (可配置)
  - [ ] 块粒度：4KB (与磁盘块对齐)
  - [ ] 替换策略：LRU with dirty bit
- [ ] 实现核心数据结构
  - [ ] 哈希表 (block_id -> cache_entry)
  - [ ] 双向链表 (LRU顺序)
  - [ ] 缓存一致性机制（write-through/write-back选择）
- [ ] 集成到filesystem.c
  - [ ] 修改read_block/write_block接口
  - [ ] 实现flush_cache接口
- [ ] 对标glibc的page cache行为
- **优先级**：🟡 中
- **预期周期**：6-7天
- **输出物**：cache.c/cache.h, 缓存命中率测试

#### Task 3.2: 多级间接块支持
- [ ] 分析当前块指针数量限制
  - [ ] 计算单层Inode可支持的最大文件大小
  - [ ] 确定分层方案（一级/二级间接块）
- [ ] 重构Inode块指针结构
  ```
  struct Inode {
    uint32_t direct_blocks[12];      // 直接块 (48KB)
    uint32_t indirect_block;         // 一级间接块 (4MB)
    uint32_t double_indirect_block;  // 二级间接块 (4GB)
  };
  ```
- [ ] 实现块分配/释放算法
  - [ ] 自动升级为间接块
  - [ ] 级联释放机制
- [ ] 修改文件上传/下载逻辑支持大文件
- **优先级**：🟡 中
- **预期周期**：4-5天
- **输出物**：Refactored inode_ops.c, 大文件测试

#### Task 3.3: 基础目录管理
- [ ] 目录操作协议扩展
  - [ ] CMD_MKDIR 实现
  - [ ] CMD_RMDIR 实现
  - [ ] CMD_LS 路径支持增强
- [ ] 目录INode特殊处理
  - [ ] 目录项结构体设计 (filename + inode_id)
  - [ ] 父目录链接 (..)
- [ ] 路径解析器实现
  - [ ] 支持绝对路径和相对路径
  - [ ] 符号链接预留接口
- **优先级**：🟡 中
- **预期周期**：3-4天
- **输出物**：directory.c, 目录操作测试

---

### **Phase 4: 应用层功能（Week 7-8）**
目标：实现论文评审工作流和Web界面

#### Task 4.1: 论文评审状态机
- [ ] 状态定义与转移
  ```
  Submitted → Under Review → {Accepted, Rejected, Revision Required}
  ```
- [ ] 状态机逻辑
  - [ ] 状态持久化 (存储到元数据)
  - [ ] 时间戳记录 (提交、审核、决定时间)
  - [ ] 评审者评论管理
- [ ] 数据库设计（SQLite）
  ```
  CREATE TABLE papers (
    id, filename, state, submitted_at, 
    reviewed_at, reviewer_id, comments
  );
  ```
- [ ] 协议扩展
  - [ ] CMD_REVIEW_SUBMIT
  - [ ] CMD_REVIEW_QUERY
  - [ ] CMD_REVIEW_UPDATE
- **优先级**：🟡 中
- **预期周期**：4-5天
- **输出物**：review_state_machine.c, review.db schema

#### Task 4.2: Web界面与API网关
- [ ] 选择框架 (建议: Flask/Express)
- [ ] REST API设计
  ```
  POST   /api/papers/upload
  GET    /api/papers/{id}
  PUT    /api/papers/{id}/review
  DELETE /api/papers/{id}
  GET    /api/papers?state=Under Review
  ```
- [ ] 前端界面
  - [ ] 论文上传表单
  - [ ] 论文列表视图 (按状态过滤)
  - [ ] 审核评论面板
  - [ ] 实时状态更新 (WebSocket)
- [ ] 与C服务器的集成
  - [ ] HTTP请求 → 二进制协议转换
  - [ ] 文件流式传输集成
- **优先级**：🟢 低
- **预期周期**：5-6天
- **输出物**：app.py, frontend/, 部署文档

#### Task 4.3: 系统集成与端到端测试
- [ ] 完整工作流测试
  - [ ] 注册 → 上传 → 查询 → 审核 → 下载
- [ ] 故障恢复测试
  - [ ] 服务器崩溃后重启数据一致性
  - [ ] 网络中断时客户端恢复
- [ ] 性能端到端基准
- **优先级**：🟡 中
- **预期周期**：3-4天
- **输出物**：e2e_test_suite.py, 集成测试报告

---

### **Phase 5: 优化与交付（Week 9-10）**
目标：性能调优、文档完善、代码发布

#### Task 5.1: 性能调优
- [ ] 磁盘I/O优化
  - [ ] 批量读写策略
  - [ ] 缓存预读 (read-ahead)
- [ ] 网络传输优化
  - [ ] Nagle算法禁用 (TCP_NODELAY)
  - [ ] 接收缓冲区调优
  - [ ] 零拷贝支持（sendfile）
- [ ] 内存优化
  - [ ] 缓冲池管理
  - [ ] 内存占用上限
- [ ] 基准重测与报告
- **优先级**：🟡 中
- **预期周期**：3-4天
- **输出物**：optimization_report.md, 性能对比图表

#### Task 5.2: 文档与代码发布
- [ ] 完整的API文档
- [ ] 部署指南
  - [ ] 编译说明
  - [ ] 配置参数表
  - [ ] 故障排查指南
- [ ] 架构设计文档
  - [ ] 系统架构图
  - [ ] 模块间交互时序图
  - [ ] 存储布局说明
- [ ] 代码审核与优化
- [ ] Git标签与Release发布
- **优先级**：🟡 中
- **预期周期**：3-4天
- **输出物**：docs/, RELEASE_NOTES.md

---

## 资源与依赖

### 开发环境需求
| 工具 | 用途 | 版本要求 |
|------|------|--------|
| GCC | C编译 | 7.0+ |
| pthread | 线程库 | POSIX |
| gtest | 单元测试 | 1.10+ |
| SQLite3 | 数据库 | 3.30+ |
| Python | 测试脚本 | 3.8+ |
| valgrind | 内存检测 | 3.16+ |

### 跨阶段依赖
```
Phase 1 (稳定化) 
    ↓
Phase 2 (高并发) 
    ↓
Phase 3 (存储优化) 
    ↓
Phase 4 (应用层)
    ↓
Phase 5 (优化交付)
```

---

## 关键里程碑

| 里程碑 | 时间 | 交付物 |
|-------|------|--------|
| M1: 原型验证 | Week 2 | 稳定的功能演示 |
| M2: 并发支持 | Week 4 | 100+ 并发测试通过 |
| M3: 大文件支持 | Week 6 | 支持GB级文件 |
| M4: 完整应用 | Week 8 | 可用的评审平台 |
| M5: 产品发布 | Week 10 | v1.0 Release |

---

## 风险评估

| 风险 | 概率 | 影响 | 缓解方案 |
|------|------|------|---------|
| 死锁问题 | 中 | 高 | Phase 2 中实施严格的锁排序 |
| 磁盘损坏 | 低 | 高 | 实施日志/WAL机制 |
| 性能不达标 | 中 | 中 | Phase 5 中进行详细的perf分析 |
| 文档滞后 | 高 | 低 | 每个Phase末进行文档同步 |

---

## 成功标准

✅ 所有单元测试通过率 > 95%
✅ 并发连接数 ≥ 512
✅ 支持最大单文件大小 ≥ 1GB
✅ 系统可用性 > 99%
✅ 代码覆盖率 > 80%
✅ 完整的API文档与部署指南
✅ 通过端到端集成测试

---

## 下一步行动

1. **确认优先级** - 按团队能力调整各阶段周期
2. **分配任务** - 将具体Task分配给开发成员
3. **建立监控** - 使用issue tracker或Trello跟踪进度
4. **每周同步** - 汇总完成度，调整计划

